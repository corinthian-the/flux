import React, { useState, useEffect, useRef } from 'react';
import { Router, Share2, Skull, Activity, Laptop, Smartphone, Server, Wifi, Play, AlertTriangle } from 'lucide-react';

interface NetworkNode {
    id: number;
    type: 'ROUTER' | 'PC' | 'PHONE' | 'SERVER' | 'IOT';
    x: number;
    y: number;
    infected: boolean;
    ip: string;
}

export const RouterExploit: React.FC = () => {
  const [targetIp, setTargetIp] = useState('192.168.1.1');
  const [payload, setPayload] = useState('wannacry.exe');
  const [exploitMethod, setExploitMethod] = useState('UPnP Injection');
  const [isScanning, setIsScanning] = useState(false);
  const [isSpreading, setIsSpreading] = useState(false);
  const [logs, setLogs] = useState<string[]>([]);
  const [nodes, setNodes] = useState<NetworkNode[]>([]);
  
  const canvasRef = useRef<HTMLCanvasElement>(null);

  // Initialize Network Graph
  useEffect(() => {
    // Central Router
    const initialNodes: NetworkNode[] = [
        { id: 0, type: 'ROUTER', x: 50, y: 50, infected: false, ip: '192.168.1.1' }
    ];
    
    // Generate Random Devices
    for (let i = 1; i <= 6; i++) {
        const types: any[] = ['PC', 'PHONE', 'SERVER', 'IOT'];
        initialNodes.push({
            id: i,
            type: types[Math.floor(Math.random() * types.length)],
            x: 50 + (Math.cos((i / 6) * Math.PI * 2) * 35),
            y: 50 + (Math.sin((i / 6) * Math.PI * 2) * 35),
            infected: false,
            ip: `192.168.1.${10 + i}`
        });
    }
    setNodes(initialNodes);
  }, []);

  // Animation Loop
  useEffect(() => {
      const canvas = canvasRef.current;
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      if (!ctx) return;

      const render = () => {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          const centerX = canvas.width / 2;
          const centerY = canvas.height / 2;
          const scaleX = canvas.width / 100;
          const scaleY = canvas.height / 100;

          // Draw Connections
          ctx.strokeStyle = '#14532d'; // green-900
          ctx.lineWidth = 2;
          nodes.forEach(node => {
              if (node.type !== 'ROUTER') {
                  const rX = nodes[0].x * scaleX;
                  const rY = nodes[0].y * scaleY;
                  const nX = node.x * scaleX;
                  const nY = node.y * scaleY;

                  ctx.beginPath();
                  ctx.moveTo(rX, rY);
                  ctx.lineTo(nX, nY);
                  ctx.stroke();

                  // Draw Packet if spreading and router is infected
                  if (isSpreading && nodes[0].infected && !node.infected) {
                      const time = Date.now() / 500;
                      const offset = time % 1;
                      const pX = rX + (nX - rX) * offset;
                      const pY = rY + (nY - rY) * offset;
                      
                      ctx.fillStyle = '#ef4444'; // Red packet
                      ctx.beginPath();
                      ctx.arc(pX, pY, 4, 0, Math.PI * 2);
                      ctx.fill();
                  }
              }
          });

          // Draw Nodes
          nodes.forEach(node => {
              const x = node.x * scaleX;
              const y = node.y * scaleY;
              
              ctx.beginPath();
              ctx.arc(x, y, node.type === 'ROUTER' ? 20 : 12, 0, Math.PI * 2);
              ctx.fillStyle = '#000';
              ctx.fill();
              
              ctx.lineWidth = 2;
              if (node.infected) {
                  ctx.strokeStyle = '#ef4444'; // Red
                  ctx.shadowColor = '#ef4444';
              } else {
                  ctx.strokeStyle = '#22c55e'; // Green
                  ctx.shadowColor = '#22c55e';
              }
              ctx.shadowBlur = 10;
              ctx.stroke();
              ctx.shadowBlur = 0;
              
              // Text
              ctx.fillStyle = node.infected ? '#ef4444' : '#22c55e';
              ctx.font = '10px monospace';
              ctx.textAlign = 'center';
              ctx.fillText(node.type, x, y + (node.type === 'ROUTER' ? 30 : 20));
          });

          requestAnimationFrame(render);
      };
      
      const anim = requestAnimationFrame(render);
      return () => cancelAnimationFrame(anim);
  }, [nodes, isSpreading]);

  const addLog = (msg: string) => {
      setLogs(prev => [...prev, `[${new Date().toLocaleTimeString()}] ${msg}`]);
  };

  const handleScan = () => {
      setIsScanning(true);
      setLogs(['Initializing Network Discovery...']);
      
      let step = 0;
      const interval = setInterval(() => {
          if (step === 0) addLog(`Probing Gateway ${targetIp}...`);
          if (step === 1) addLog(`Gateway found: Linksys WRT54G (Vulnerable)`);
          if (step === 2) addLog(`Identifying connected hosts...`);
          if (step === 3) {
              setNodes(prev => prev.map(n => ({...n, infected: false}))); // Reset
              addLog(`Found ${nodes.length - 1} connected devices.`);
              setIsScanning(false);
              clearInterval(interval);
          }
          step++;
      }, 800);
  };

  const handleSpread = () => {
      if (isSpreading) return;
      setIsSpreading(true);
      setLogs(prev => [...prev, `Starting ${payload} propagation service...`]);

      // Step 1: Infect Router
      setTimeout(() => {
          addLog(`Exploiting ${targetIp} via ${exploitMethod}...`);
          addLog(`Privilege Escalation: ROOT access granted.`);
          setNodes(prev => prev.map(n => n.type === 'ROUTER' ? { ...n, infected: true } : n));
          
          // Step 2: Infect Devices one by one
          let deviceIdx = 1;
          const interval = setInterval(() => {
              if (deviceIdx >= nodes.length) {
                  clearInterval(interval);
                  addLog(`Propagation Complete. Botnet active.`);
                  setIsSpreading(false);
                  return;
              }
              
              const currentNodeId = nodes[deviceIdx].id;
              setNodes(prev => prev.map(n => n.id === currentNodeId ? { ...n, infected: true } : n));
              addLog(`Infecting ${nodes[deviceIdx].ip} (${nodes[deviceIdx].type})... SUCCESS`);
              deviceIdx++;
          }, 1500);

      }, 1500);
  };

  return (
    <div className="h-full flex flex-col bg-[#050505] text-green-500 font-mono select-none">
        {/* Header */}
        <div className="flex items-center justify-between p-3 border-b border-green-900 bg-green-900/10">
            <div className="flex items-center gap-2">
                <Router size={20} className="text-red-500" />
                <div>
                    <h1 className="font-bold tracking-widest text-sm text-white">NET_SPREADER_V1</h1>
                    <p className="text-[10px] text-green-700">Autonomous Malware Propagation Tool</p>
                </div>
            </div>
            {isSpreading && <Activity size={18} className="animate-pulse text-red-500" />}
        </div>

        <div className="flex-1 flex min-h-0">
            {/* Sidebar Controls */}
            <div className="w-64 border-r border-green-900 p-4 flex flex-col gap-4 bg-[#0a0a0a]">
                <div className="space-y-1">
                    <label className="text-[10px] uppercase font-bold text-gray-500 flex items-center gap-1">
                        <Wifi size={10} /> Target Gateway
                    </label>
                    <input 
                        type="text" 
                        value={targetIp}
                        onChange={(e) => setTargetIp(e.target.value)}
                        className="w-full bg-[#111] border border-green-800 p-2 text-xs focus:border-red-500 outline-none text-white"
                    />
                </div>

                <div className="space-y-1">
                    <label className="text-[10px] uppercase font-bold text-gray-500 flex items-center gap-1">
                        <AlertTriangle size={10} /> Exploit Vector
                    </label>
                    <select 
                        value={exploitMethod}
                        onChange={(e) => setExploitMethod(e.target.value)}
                        className="w-full bg-[#111] border border-green-800 p-2 text-xs text-white outline-none"
                    >
                        <option>UPnP Injection</option>
                        <option>Default Credentials (admin/admin)</option>
                        <option>Firmware Backdoor (CVE-2024-001)</option>
                        <option>DNS Rebinding</option>
                    </select>
                </div>

                <div className="space-y-1">
                    <label className="text-[10px] uppercase font-bold text-gray-500 flex items-center gap-1">
                        <Skull size={10} /> Payload
                    </label>
                    <select 
                        value={payload}
                        onChange={(e) => setPayload(e.target.value)}
                        className="w-full bg-[#111] border border-green-800 p-2 text-xs text-white outline-none"
                    >
                        <option value="wannacry.exe">WannaCry (Ransomware)</option>
                        <option value="memz.exe">MEMZ (Trojan)</option>
                        <option value="mirai.bin">Mirai (Botnet)</option>
                        <option value="keylogger.py">Silent Keylogger</option>
                    </select>
                </div>

                <div className="pt-4 space-y-2 mt-auto">
                    <button 
                        onClick={handleScan}
                        disabled={isScanning || isSpreading}
                        className="w-full py-2 border border-green-700 hover:bg-green-900/30 text-green-500 text-xs font-bold disabled:opacity-50"
                    >
                        {isScanning ? 'SCANNING...' : 'SCAN NETWORK'}
                    </button>
                    <button 
                        onClick={handleSpread}
                        disabled={isScanning || isSpreading}
                        className="w-full py-3 bg-red-900/20 border border-red-800 hover:bg-red-600 hover:text-black hover:border-red-500 transition-all font-bold text-xs flex items-center justify-center gap-2 disabled:opacity-50"
                    >
                        <Share2 size={14} /> INJECT & SPREAD
                    </button>
                </div>
            </div>

            {/* Visualizer Area */}
            <div className="flex-1 flex flex-col relative bg-black">
                <canvas ref={canvasRef} width={600} height={400} className="w-full h-full" />
                
                {/* Overlay Logs */}
                <div className="absolute bottom-0 left-0 right-0 h-32 bg-black/80 border-t border-green-900/50 p-2 font-mono text-[10px] overflow-y-auto custom-scrollbar backdrop-blur-sm">
                    {logs.map((log, i) => (
                        <div key={i} className={log.includes('SUCCESS') || log.includes('Complete') ? 'text-red-500 font-bold' : 'text-green-600'}>
                            {log}
                        </div>
                    ))}
                    {logs.length === 0 && <span className="text-gray-600 italic">Waiting for command...</span>}
                </div>
            </div>
        </div>
    </div>
  );
};